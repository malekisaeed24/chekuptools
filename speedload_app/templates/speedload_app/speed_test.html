<form id="speedTestForm" method="POST">
    {% csrf_token %}
    <label for="url">Website URL:</label>
    <input type="text" id="url" name="url" placeholder="Enter website URL">
    <button type="submit">Start Test</button>
</form>

<div id="result">
    <!-- نتیجه تست سرعت اینجا نمایش داده می‌شود -->
</div>

<script>
    // تابع برای دریافت توکن CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.getElementById('speedTestForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const formData = new FormData(this);

    fetch(window.location.origin + '/speed-test/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')  // اضافه کردن توکن CSRF به هدر
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);  // چاپ پاسخ دریافتی برای بررسی
        if (data.error) {
            document.getElementById('result').innerText = 'خطا: ' + data.error;
        } else {
            document.getElementById('result').innerHTML = `
                زمان بارگذاری (HTML): ${(data.html && data.html.time) ? data.html.time.toFixed(2) : 'N/A'} ثانیه <br>
                اندازه HTML: ${(data.html && data.html.size) ? data.html.size : 'N/A'} بایت <br>
                زمان بارگذاری CSS: ${(data.css && data.css.time) ? data.css.time.toFixed(2) : 'N/A'} ثانیه <br>
                اندازه CSS: ${(data.css && data.css.size) ? data.css.size : 'N/A'} بایت <br>
                زمان بارگذاری JS: ${(data.js && data.js.time) ? data.js.time.toFixed(2) : 'N/A'} ثانیه <br>
                اندازه JS: ${(data.js && data.js.size) ? data.js.size : 'N/A'} بایت <br>
                زمان بارگذاری تصاویر: ${(data.img && data.img.time) ? data.img.time.toFixed(2) : 'N/A'} ثانیه <br>
                اندازه تصاویر: ${(data.img && data.img.size) ? data.img.size : 'N/A'} بایت <br>
            `;
        }
    })
    .catch(error => console.error('خطا:', error));
});

</script>
